<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="Glassmorphism.css">
    <title>Document</title>
</head>
<body>
    <div class="layout">
        <div class="side" id="div_cam" style="visibility: hidden;">
            <img src="https://googly-enteric-noreen.ngrok-free.dev/video">
        </div>
        
        <div class="card glow">
            <div class="time" id="time">Time: </div>
            <div class="values">  
                <div class="box"><div class="val" id="tmp"></div><div class="label">Temperature</div></div>
                <div class="box"><div class="val" id="hum"></div><div class="label">Humidity</div></div>
                <div class="box"><div class="val" id="gas"></div><div class="label">Gas</div></div>
            </div>
            <div style="margin-bottom: 20px;">
                <button onclick="pre()">◀</button>
                <div id="result_index" style="display: inline-block; font-size: 20px;"></div>
                <button onclick="next()">▶</button>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <button id="show_left" onclick="showCam()">Show Camera</button>
                <button id="show_right" onclick="showiFrame()">Show Charts</button> 
            </div>
        </div>
        
        <div class="side" id="div_chart" style="visibility: hidden; text-align: center;">
            <iframe id="chart" width="450" height="260" style="border: 1px solid #cccccc;" src="https://thingspeak.mathworks.com/channels/3138878/charts/1?key=VX25ECR2BGI603CW&bgcolor=%23ffffff&color=%23d62020&dynamic=true&results=20&title=Title+A&type=line"></iframe>
            <button id="next_chart" onclick="next_chart()">Next chart</button>
        </div>
    </div>
</body>
<script>

    const NUM_OF_RESULT = 10;
    let currentIndex = NUM_OF_RESULT - 1;
    let feeds = [];
    let currentChartIndex = 0;

    async function fetchData() {
        try {
            const response = await fetch('https://api.thingspeak.com/channels/3138878/feeds.json?key=VX25ECR2BGI603CW&results=' + NUM_OF_RESULT);
            const data = await response.json();
            console.log(data);
            feeds = data.feeds;
            display();
            
        } catch (error) {
            console.error('Error fetching data:', error);
        }
    }

    function next() {
        currentIndex = (currentIndex + 1) % NUM_OF_RESULT;
        display();
    }

    function pre() {
        currentIndex = (currentIndex - 1 + NUM_OF_RESULT) % NUM_OF_RESULT;
        display();
    }


    function display(){
        document.getElementById('result_index').innerText = (currentIndex + 1) + ' / ' + NUM_OF_RESULT;
        document.getElementById('tmp').innerText = Number(feeds[currentIndex].field1).toFixed(1) + ' °C';
        document.getElementById('hum').innerText = Number(feeds[currentIndex].field2).toFixed(1) + ' %';
        document.getElementById('gas').innerText = Number(feeds[currentIndex].field3).toFixed(0);
        let date = new Date(feeds[currentIndex].created_at).toLocaleString("en-ZA", { timeZone: "Asia/Hong_Kong", hour12: true });
        document.getElementById('time').innerText = date;
    }

    function next_chart() {
        currentChartIndex = (currentChartIndex + 1) % 3;
        const iframe = document.getElementById('chart');
        const chartUrl = "https://thingspeak.mathworks.com/channels/3138878/charts/" + String(currentChartIndex + 1) +"?key=VX25ECR2BGI603CW&bgcolor=%23ffffff&color=%23d62020&dynamic=true&results=20&title=Title+A&type=line";
        iframe.src = chartUrl;
    }

    function showCam(){
        const img = document.getElementById('div_cam');
        const Btn = document.getElementById('show_left');
        if (img.style.visibility === 'visible') {
            Btn.innerText = 'Show Camera';
            img.style.visibility = 'hidden';
        }else{
            Btn.innerText = 'Hide Camera';
            img.style.visibility = 'visible';   
        }
    }

    function showiFrame(){
        const iframe = document.getElementById('div_chart');
        const Btn = document.getElementById('show_right');
        if (iframe.style.visibility === 'visible') {
            Btn.innerText = 'Show Charts';
            iframe.style.visibility = 'hidden';
            
        }else{
            Btn.innerText = 'Hide Charts';
            iframe.style.visibility = 'visible';   
        }
    }

    //setInterval(fetchData, 5000); // Fetch data every 5 seconds
    fetchData();
</script>
</html>